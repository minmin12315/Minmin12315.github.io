<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Ultra-Max 3D Racer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
html,body{margin:0;padding:0;overflow:hidden;background:#111;font-family:monospace;}
canvas{display:block;}
#hud{position:absolute;top:10px;left:10px;color:white;font-size:16px;}
#controls{position:absolute;bottom:20px;width:100%;display:flex;justify-content:center;gap:20px;}
.button{width:60px;height:60px;background:#333;border-radius:50%;color:white;font-size:18px;text-align:center;line-height:60px;user-select:none;}
</style>
</head>
<body>
<canvas id="c"></canvas>
<div id="hud"></div>
<div id="controls">
  <div class="button" id="left">◀</div>
  <div class="button" id="up">▲</div>
  <div class="button" id="right">▶</div>
  <div class="button" id="nitro">⚡</div>
</div>

<script>
const canvas=document.getElementById("c"),ctx=canvas.getContext("2d"),hud=document.getElementById("hud");
let W=canvas.width=innerWidth,H=canvas.height=innerHeight;
onresize=()=>{W=canvas.width=innerWidth;H=canvas.height=innerHeight;}

/* INPUT */
const keys={};
document.addEventListener("keydown",e=>keys[e.key.toLowerCase()]=true);
document.addEventListener("keyup",e=>keys[e.key.toLowerCase()]=false);
/* Touch */
document.getElementById("left").ontouchstart=()=>keys["arrowleft"]=true;
document.getElementById("left").ontouchend=()=>keys["arrowleft"]=false;
document.getElementById("right").ontouchstart=()=>keys["arrowright"]=true;
document.getElementById("right").ontouchend=()=>keys["arrowright"]=false;
document.getElementById("up").ontouchstart=()=>keys["arrowup"]=true;
document.getElementById("up").ontouchend=()=>keys["arrowup"]=false;
document.getElementById("nitro").ontouchstart=()=>keys[" "]=true;
document.getElementById("nitro").ontouchend=()=>keys[" "]=false;

/* GAME STATE */
let speed=0,maxSpeed=220,accel=140,brake=250,playerX=0,drift=0;
let pos=0,lap=1,score=0,high=+localStorage.high||0,nitro=100,nitroOn=false,time=0;

/* ROAD */
const segLen=200,roadW=2000,camDepth=0.84,road=[];
for(let i=0;i<2000;i++){
  road.push({
    curve:Math.sin(i/50)*2,
    hill:Math.sin(i/60)*50,
    obstacle:Math.random()<0.02,
    ai:Math.random()<0.015
  });
}

/* PROJECTION */
function project(p,camX,camY,camZ){
  const scale=camDepth/(p.z-camZ);
  p.x=(1+scale*(p.wx-camX))*W/2;
  p.y=(1-scale*(p.wy-camY))*H/2;
  p.w=scale*roadW*W/2;
}

/* UPDATE */
function update(dt){
  time+=dt*0.05;
  if(keys["arrowup"]) speed+=accel*dt; else speed-=accel*dt*0.4;
  if(keys["arrowdown"]) speed-=brake*dt;
  if(keys[" "] && nitro>0){ nitroOn=true; speed+=300*dt; nitro-=50*dt;} else nitroOn=false;
  speed=Math.max(0,Math.min(speed,maxSpeed+(nitroOn?100:0)));
  if(keys["arrowleft"]) drift-=speed*dt*0.03;
  if(keys["arrowright"]) drift+=speed*dt*0.03;
  playerX+=drift; drift*=0.85;
  pos+=speed*dt; score+=speed*dt*0.1;
  if(pos>road.length*segLen){pos=0;lap++;}
}

/* DRAW */
function draw(){
  /* SKY */
  const sky=ctx.createLinearGradient(0,0,0,H);
  sky.addColorStop(0,`hsl(${200-time*50},60%,50%)`);
  sky.addColorStop(1,"#111");
  ctx.fillStyle=sky; ctx.fillRect(0,0,W,H);

  /* ROAD */
  let x=0,dx=0,base=Math.floor(pos/segLen);
  for(let n=0;n<300;n++){
    const seg=road[(base+n)%road.length];
    const p1={wx:x,wy:seg.hill,z:n*segLen},p2={wx:x+dx,wy:seg.hill,z:(n+1)*segLen};
    project(p1,playerX,900,pos); project(p2,playerX,900,pos);
    dx+=seg.curve;x+=dx;
    ctx.fillStyle=n%2?"#555":"#666";
    ctx.beginPath();
    ctx.moveTo(p1.x-p1.w,p1.y);
    ctx.lineTo(p2.x-p2.w,p2.y);
    ctx.lineTo(p2.x+p2.w,p2.y);
    ctx.lineTo(p1.x+p1.w,p1.y);
    ctx.fill();

    /* obstacles */
    if(seg.obstacle && n<6 && Math.abs(playerX-x)<80){ speed*=0.5; }

    /* AI cars */
    if(seg.ai){ ctx.fillStyle="blue"; ctx.fillRect(p2.x-35,p2.y-45,30,45);}
  }

  /* PLAYER */
  ctx.fillStyle=nitroOn?"cyan":"red";
  ctx.fillRect(W/2-25+drift*20,H-90,50,70);

  /* HUD */
  hud.innerHTML=`Speed:${Math.floor(speed)}<br>Nitro:${Math.floor(nitro)}<br>Lap:${lap}<br>Score:${Math.floor(score)}<br>High:${high}`;
}

/* LOOP */
let last=performance.now();
function loop(t){
  const dt=(t-last)/1000; last=t;
  update(dt); draw();
  requestAnimationFrame(loop);
}
loop(last);

/* SYSTEM */
setInterval(()=>{ nitro=Math.min(100,nitro+10); if(score>high){high=score;localStorage.high=high;} },1000);
</script>
</body>
</html>
